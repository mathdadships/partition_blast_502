<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  PARTITION BLAST v7 - With Perfect Score Celebration                         ‚ïë
‚ïë  Get all 12 correct in a row for the PERFECT celebration!                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üí• Partition Blast!</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        #game-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 10px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .shake {
            animation: screenShake 0.3s ease;
        }

        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-4px) rotate(-0.5deg); }
            40% { transform: translateX(4px) rotate(0.5deg); }
            60% { transform: translateX(-2px) rotate(-0.25deg); }
            80% { transform: translateX(2px) rotate(0.25deg); }
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            color: white;
        }

        #title {
            font-family: 'Bangers', cursive;
            font-size: 28px;
            color: #ffd93d;
            text-shadow: 2px 2px 0 #e74c3c, 4px 4px 0 rgba(0,0,0,0.3);
        }

        #stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #ffd93d;
            transition: transform 0.2s ease;
        }

        .stat-value.pop {
            animation: statPop 0.3s ease;
        }

        @keyframes statPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        #streak-container {
            position: relative;
        }

        #streak.hot {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.8);
        }

        #streak.fire {
            color: #ff9f43;
            text-shadow: 0 0 15px rgba(255, 159, 67, 0.9);
            animation: fireGlow 0.5s ease infinite alternate;
        }

        @keyframes fireGlow {
            to { text-shadow: 0 0 25px rgba(255, 159, 67, 1), 0 0 35px rgba(255, 107, 107, 0.5); }
        }

        #game-area {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }

        #block-stack {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            border: 3px solid rgba(255,255,255,0.1);
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 8px;
            overflow: hidden;
            position: relative;
        }

        .partition-row {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            opacity: 0.4;
            transform: scale(0.94);
            filter: saturate(0.5);
        }

        .partition-row.next {
            opacity: 0.7;
            transform: scale(0.97);
            filter: saturate(0.8);
            box-shadow: 0 0 0 2px rgba(255, 217, 61, 0.3), 0 4px 0 rgba(0,0,0,0.3);
        }

        .partition-row.current {
            opacity: 1;
            transform: scale(1);
            filter: saturate(1);
            box-shadow: 0 0 0 4px #ff6b6b, 0 0 25px rgba(255, 107, 107, 0.6), 0 4px 0 rgba(0,0,0,0.3);
            animation: rainbowGlow 2s linear infinite;
        }

        @keyframes rainbowGlow {
            0% { box-shadow: 0 0 0 4px #ff6b6b, 0 0 25px rgba(255, 107, 107, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
            16% { box-shadow: 0 0 0 4px #ffd93d, 0 0 25px rgba(255, 217, 61, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
            33% { box-shadow: 0 0 0 4px #4ecdc4, 0 0 25px rgba(78, 205, 196, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
            50% { box-shadow: 0 0 0 4px #667eea, 0 0 25px rgba(102, 126, 234, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
            66% { box-shadow: 0 0 0 4px #a55eea, 0 0 25px rgba(165, 94, 234, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
            83% { box-shadow: 0 0 0 4px #ff6b9d, 0 0 25px rgba(255, 107, 157, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
            100% { box-shadow: 0 0 0 4px #ff6b6b, 0 0 25px rgba(255, 107, 107, 0.6), 0 4px 0 rgba(0,0,0,0.3); }
        }

        .partition-row.flash {
            animation: flashWhite 0.15s ease;
        }

        @keyframes flashWhite {
            0% { filter: brightness(1); }
            50% { filter: brightness(2); }
            100% { filter: brightness(1); }
        }

        .partition-row.exploding {
            animation: explode 0.4s ease forwards;
        }

        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            20% { transform: scale(1.15); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0; height: 0; margin: 0; padding: 0; }
        }

        .partition-row.wrong {
            animation: wrongShake 0.4s ease;
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0) scale(1); }
            20% { transform: translateX(-8px) scale(1); }
            40% { transform: translateX(8px) scale(1); }
            60% { transform: translateX(-4px) scale(1); }
            80% { transform: translateX(4px) scale(1); }
        }

        .partition-row.settling {
            animation: settle 0.3s ease;
        }

        @keyframes settle {
            0% { transform: translateY(-10px); }
            60% { transform: translateY(2px); }
            100% { transform: translateY(0); }
        }

        .block-part {
            flex: 1;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
            border-right: 2px solid rgba(0,0,0,0.2);
            position: relative;
        }

        .block-part:last-child {
            border-right: none;
        }

        .block-part::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 6px;
            background: inherit;
            filter: brightness(1.2);
            border-radius: 3px 3px 0 0;
        }

        .block-red .block-part { background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%); }
        .block-yellow .block-part { background: linear-gradient(180deg, #ffd93d 0%, #f0c830 100%); }
        .block-green .block-part { background: linear-gradient(180deg, #4ecdc4 0%, #3dbdb5 100%); }
        .block-blue .block-part { background: linear-gradient(180deg, #667eea 0%, #5a6fd6 100%); }
        .block-purple .block-part { background: linear-gradient(180deg, #a55eea 0%, #8e44ad 100%); }
        .block-pink .block-part { background: linear-gradient(180deg, #ff6b9d 0%, #e84393 100%); }
        .block-orange .block-part { background: linear-gradient(180deg, #ff9f43 0%, #e17055 100%); }
        .block-cyan .block-part { background: linear-gradient(180deg, #00d2d3 0%, #01a3a4 100%); }

        #button-panel {
            width: 140px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .fraction-btn {
            background: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
            border: none;
            border-radius: 12px;
            padding: 16px 10px;
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 4px 0 #1a252f;
            text-align: center;
        }

        .fraction-btn:hover {
            background: linear-gradient(180deg, #4a6278 0%, #34495e 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #1a252f;
        }

        .fraction-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1a252f;
        }

        .fraction-btn.correct {
            background: linear-gradient(180deg, #2ed573 0%, #1abc9c 100%);
            box-shadow: 0 4px 0 #16a085;
            animation: btnPop 0.3s ease;
        }

        .fraction-btn.wrong {
            background: linear-gradient(180deg, #E8A838 0%, #d4882a 100%);
            box-shadow: 0 4px 0 #b8741f;
            animation: btnShake 0.4s ease;
        }

        @keyframes btnPop {
            50% { transform: scale(1.1); }
        }

        @keyframes btnShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .fraction-btn .btn-fraction {
            font-size: 14px;
            opacity: 0.7;
            display: block;
            margin-top: 2px;
        }

        #progress-container {
            margin-top: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #1abc9c);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        #progress-text {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            text-align: center;
            margin-top: 5px;
        }

        #speed-bonus {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #ffd93d;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #speed-bonus.show {
            opacity: 1;
            animation: speedPop 0.5s ease;
        }

        @keyframes speedPop {
            0% { transform: translateY(-50%) scale(0.5); }
            50% { transform: translateY(-50%) scale(1.2); }
            100% { transform: translateY(-50%) scale(1); }
        }

        #start-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        #start-screen.hidden {
            display: none;
        }

        .start-title {
            font-family: 'Bangers', cursive;
            font-size: 48px;
            color: #ffd93d;
            text-shadow: 3px 3px 0 #e74c3c, 6px 6px 0 rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .start-subtitle {
            font-size: 18px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
            text-align: center;
        }

        .demo-area {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .demo-instruction {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .demo-block {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto 15px;
            box-shadow: 0 0 0 4px #ffd93d, 0 4px 0 rgba(0,0,0,0.3);
            width: fit-content;
        }

        .demo-part {
            width: 45px;
            height: 40px;
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            border-right: 2px solid rgba(0,0,0,0.2);
            position: relative;
        }

        .demo-part:last-child { border-right: none; }

        .demo-part::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 5px;
            background: linear-gradient(180deg, #ff8a8a 0%, #ee5a5a 100%);
            border-radius: 2px 2px 0 0;
        }

        .demo-result {
            color: #ffd93d;
            font-size: 20px;
            font-weight: 600;
        }

        .best-score {
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            margin-bottom: 20px;
        }

        #start-btn {
            background: linear-gradient(180deg, #2ed573 0%, #1abc9c 100%);
            border: none;
            border-radius: 16px;
            padding: 20px 60px;
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 0 #16a085;
            transition: all 0.15s ease;
        }

        #start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #16a085;
        }

        #start-btn:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #16a085;
        }

        .combo-text {
            position: fixed;
            font-family: 'Bangers', cursive;
            font-size: 32px;
            color: #ffd93d;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 200;
            animation: comboFloat 0.8s ease forwards;
        }

        .combo-text.perfect {
            font-size: 40px;
            color: #ff6b9d;
        }

        @keyframes comboFloat {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
        }

        #message-popup {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            z-index: 200;
            transition: transform 0.2s ease;
        }

        #message-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        #message-popup.correct {
            border: 3px solid #2ed573;
        }

        #message-popup.wrong {
            border: 3px solid #E8A838;
        }

        .message-emoji {
            font-size: 36px;
            margin-bottom: 5px;
        }

        .message-text {
            font-family: 'Bangers', cursive;
            font-size: 24px;
            color: #333;
        }

        .message-subtext {
            font-size: 14px;
            color: #666;
            margin-top: 3px;
        }

        /* ========== REGULAR END SCREEN ========== */
        #end-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        #end-screen.show {
            display: flex;
        }

        .end-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .end-title {
            font-family: 'Bangers', cursive;
            font-size: 48px;
            color: #ffd93d;
            margin-bottom: 20px;
            text-align: center;
        }

        .end-stats {
            color: white;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .end-stats-detail {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .new-best {
            color: #ffd93d;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            animation: newBestPulse 0.5s ease infinite alternate;
        }

        @keyframes newBestPulse {
            to { transform: scale(1.05); }
        }

        #play-again-btn {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 16px;
            padding: 20px 50px;
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 0 #4a3a7a;
        }

        #play-again-btn:hover {
            transform: translateY(-2px);
        }

        /* ========== PERFECT SCORE SCREEN ========== */
        #perfect-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 400;
        }

        #perfect-screen.show {
            display: flex;
        }

        .perfect-trophy {
            font-size: 120px;
            animation: trophyBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
        }

        @keyframes trophyBounce {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            60% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .perfect-title {
            font-family: 'Bangers', cursive;
            font-size: 72px;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #4ecdc4, #667eea, #a55eea, #ff6b9d, #ff6b6b);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rainbowShimmer 2s linear infinite, titlePop 0.6s ease 0.3s both;
            margin: 20px 0;
        }

        @keyframes rainbowShimmer {
            to { background-position: 200% center; }
        }

        @keyframes titlePop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .perfect-subtitle {
            font-size: 28px;
            color: white;
            opacity: 0;
            animation: fadeUp 0.5s ease 0.6s forwards;
        }

        .perfect-score {
            font-family: 'Bangers', cursive;
            font-size: 48px;
            color: #ffd93d;
            margin: 30px 0;
            opacity: 0;
            animation: fadeUp 0.5s ease 0.9s forwards;
        }

        .perfect-streak-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff9f43, #e74c3c);
            padding: 10px 30px;
            border-radius: 30px;
            color: white;
            font-size: 24px;
            font-weight: 600;
            opacity: 0;
            animation: fadeUp 0.5s ease 1.1s forwards;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .perfect-new-best {
            color: #ffd93d;
            font-size: 20px;
            font-weight: 600;
            margin-top: 20px;
            opacity: 0;
            animation: fadeUp 0.5s ease 1.3s forwards;
        }

        #perfect-play-again-btn {
            margin-top: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 20px 50px;
            border-radius: 16px;
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0;
            animation: fadeUp 0.5s ease 1.5s forwards;
            box-shadow: 0 6px 0 #4a3a7a;
            transition: transform 0.2s;
        }

        #perfect-play-again-btn:hover {
            transform: translateY(-3px);
        }

        @keyframes fadeUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .star-burst {
            position: absolute;
            width: 300px;
            height: 300px;
            animation: starRotate 20s linear infinite;
            pointer-events: none;
        }

        .star-burst::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(255, 215, 0, 0.3) 10deg, transparent 20deg);
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        @keyframes starRotate {
            to { transform: rotate(360deg); }
        }

        .screen-flash {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            animation: flash 0.5s ease-out forwards;
            pointer-events: none;
            z-index: 500;
        }

        @keyframes flash {
            0% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        /* ========== PARTICLES / FRAGMENTS ========== */
        .fragment {
            position: fixed;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            pointer-events: none;
            z-index: 150;
        }

        .particle {
            position: fixed;
            pointer-events: none;
            font-size: 20px;
            z-index: 150;
        }

        .confetti {
            position: fixed;
            top: -10px;
            z-index: 160;
            animation: confettiFall 2s ease forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .floating-star {
            position: fixed;
            font-size: 30px;
            animation: floatStar 3s ease-in-out infinite;
            opacity: 0.8;
            pointer-events: none;
            z-index: 350;
        }

        @keyframes floatStar {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .gold-particle {
            position: fixed;
            bottom: -20px;
            width: 8px;
            height: 8px;
            background: gold;
            border-radius: 50%;
            pointer-events: none;
            z-index: 350;
            box-shadow: 0 0 10px gold;
        }

        .firework {
            position: fixed;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 350;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <div id="title">üí• PARTITION BLAST</div>
            <div id="stats">
                <div class="stat">
                    <div class="stat-label">Score</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat" id="streak-container">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="streak">0 üî•</div>
                </div>
            </div>
        </div>

        <div id="game-area">
            <div id="block-stack"></div>
            <div id="button-panel">
                <button class="fraction-btn" data-parts="2">Halves<span class="btn-fraction">¬Ω</span></button>
                <button class="fraction-btn" data-parts="3">Thirds<span class="btn-fraction">‚Öì</span></button>
                <button class="fraction-btn" data-parts="4">Fourths<span class="btn-fraction">¬º</span></button>
                <button class="fraction-btn" data-parts="5">Fifths<span class="btn-fraction">‚Öï</span></button>
                <button class="fraction-btn" data-parts="6">Sixths<span class="btn-fraction">‚Öô</span></button>
                <button class="fraction-btn" data-parts="8">Eighths<span class="btn-fraction">‚Öõ</span></button>
            </div>
        </div>

        <div id="progress-container">
            <div id="progress-bar"></div>
            <div id="speed-bonus">‚ö° QUICK!</div>
        </div>
        <div id="progress-text">0 / 12 blocks cleared</div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen">
        <div class="start-title">üí• PARTITION BLAST</div>
        <div class="start-subtitle">Blast through the stack by naming each partition!</div>
        <div class="demo-area">
            <div class="demo-instruction">This block has 4 equal parts...</div>
            <div class="demo-block">
                <div class="demo-part">1</div>
                <div class="demo-part">2</div>
                <div class="demo-part">3</div>
                <div class="demo-part">4</div>
            </div>
            <div class="demo-result">4 parts = FOURTHS! üí•</div>
        </div>
        <div class="best-score" id="best-score-display"></div>
        <button id="start-btn">START BLASTING! üöÄ</button>
    </div>

    <!-- Message Popup -->
    <div id="message-popup">
        <div class="message-emoji" id="msg-emoji">‚≠ê</div>
        <div class="message-text" id="msg-text">Nice!</div>
        <div class="message-subtext" id="msg-subtext"></div>
    </div>

    <!-- Regular End Screen -->
    <div id="end-screen">
        <div class="end-emoji">üéì</div>
        <div class="end-title">You're a Mathematician!</div>
        <div class="end-stats">Score: <span id="final-score">0</span></div>
        <div class="end-stats-detail">Best Streak: <span id="best-streak">0</span> | Time: <span id="final-time">0s</span></div>
        <div class="new-best" id="new-best" style="display: none;">üèÜ NEW BEST SCORE!</div>
        <button id="play-again-btn">Play Again üîÑ</button>
    </div>

    <!-- PERFECT Score Screen -->
    <div id="perfect-screen">
        <div class="star-burst"></div>
        <div class="perfect-trophy">üèÜ</div>
        <div class="perfect-title">PERFECT!</div>
        <div class="perfect-subtitle">You didn't miss a single one!</div>
        <div class="perfect-score" id="perfect-score-display">312 points</div>
        <div class="perfect-streak-badge">üî• 12 streak - FLAWLESS!</div>
        <div class="perfect-new-best" id="perfect-new-best" style="display: none;">üèÜ NEW BEST SCORE!</div>
        <button id="perfect-play-again-btn">Play Again üöÄ</button>
    </div>

    <script>
        // ========== CONFIG ==========
        const COLORS = ['red', 'yellow', 'green', 'blue', 'purple', 'pink', 'orange', 'cyan'];
        const COLOR_HEX = {
            red: '#ff6b6b', yellow: '#ffd93d', green: '#4ecdc4', blue: '#667eea',
            purple: '#a55eea', pink: '#ff6b9d', orange: '#ff9f43', cyan: '#00d2d3'
        };
        const PART_OPTIONS = [2, 3, 4, 5, 6, 8];
        const TOTAL_BLOCKS = 12;
        const SPEED_BONUS_THRESHOLD = 1.5;
        const PERFECT_THRESHOLD = 0.8;

        const HYPE_MESSAGES = [
            "Slay!", "Goated!", "W!", "Fire!", "No cap!", "Bussin!", "SHEESH!", 
            "Period!", "It's giving!", "Main character!", "Ate that!"
        ];

        const GROWTH_MESSAGES = [
            "Mistakes help us grow!", "Keep trying!", "You've got this!", 
            "Learning in progress!", "Almost there!", "Mistakes in math are OK!"
        ];

        // ========== STATE ==========
        let score = 0;
        let streak = 0;
        let bestStreak = 0;
        let blocks = [];
        let currentIndex = 0;
        let gameActive = false;
        let canAnswer = true;
        let lastAnswerTime = 0;
        let gameStartTime = 0;
        let allTimeBestScore = parseInt(localStorage.getItem('partitionBlastBest') || '0');

        // ========== AUDIO ==========
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBlastSound(streakCount, blockIndex) {
            if (!audioCtx) return;
            const progressPitch = 1 + (blockIndex / TOTAL_BLOCKS) * 0.15;
            const streakPitch = 1 + (Math.min(streakCount, 10) * 0.04);
            const pitchMultiplier = progressPitch * streakPitch;

            const bass = audioCtx.createOscillator();
            const bassGain = audioCtx.createGain();
            bass.type = 'sine';
            bass.frequency.setValueAtTime(150 * pitchMultiplier, audioCtx.currentTime);
            bass.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.12);
            bassGain.gain.setValueAtTime(0.35, audioCtx.currentTime);
            bassGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            bass.connect(bassGain);
            bassGain.connect(audioCtx.destination);
            bass.start();
            bass.stop(audioCtx.currentTime + 0.15);

            const pop = audioCtx.createOscillator();
            const popGain = audioCtx.createGain();
            pop.type = 'sine';
            pop.frequency.setValueAtTime(880 * pitchMultiplier, audioCtx.currentTime);
            pop.frequency.exponentialRampToValueAtTime(440 * pitchMultiplier, audioCtx.currentTime + 0.06);
            popGain.gain.setValueAtTime(0.25, audioCtx.currentTime);
            popGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
            pop.connect(popGain);
            popGain.connect(audioCtx.destination);
            pop.start();
            pop.stop(audioCtx.currentTime + 0.08);

            const baseNotes = [1318, 1568, 2093];
            const extraNotes = streakCount >= 3 ? [2637] : [];
            const moreNotes = streakCount >= 6 ? [3136] : [];
            const chimeNotes = [...baseNotes, ...extraNotes, ...moreNotes].map(n => n * pitchMultiplier);

            chimeNotes.forEach((freq, i) => {
                setTimeout(() => {
                    if (!audioCtx) return;
                    const chime = audioCtx.createOscillator();
                    const chimeGain = audioCtx.createGain();
                    chime.type = 'sine';
                    chime.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    chimeGain.gain.setValueAtTime(0.12, audioCtx.currentTime);
                    chimeGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);
                    chime.connect(chimeGain);
                    chimeGain.connect(audioCtx.destination);
                    chime.start();
                    chime.stop(audioCtx.currentTime + 0.25);
                }, i * 35);
            });

            const bufferSize = audioCtx.sampleRate * 0.08;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            const noiseGain = audioCtx.createGain();
            const noiseFilter = audioCtx.createBiquadFilter();
            noise.buffer = noiseBuffer;
            noiseFilter.type = 'highpass';
            noiseFilter.frequency.setValueAtTime(3000, audioCtx.currentTime);
            noiseGain.gain.setValueAtTime(0.06, audioCtx.currentTime);
            noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.06);
            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);
            noise.start();
            noise.stop(audioCtx.currentTime + 0.08);
        }

        function playWrongSound() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(250, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(180, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }

        function playWinSound() {
            if (!audioCtx) return;
            const notes = [523, 659, 784, 1047, 1319, 1568];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    if (!audioCtx) return;
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.18, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.35);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.35);
                }, i * 70);
            });
            setTimeout(() => {
                if (!audioCtx) return;
                [1047, 1319, 1568, 2093].forEach(freq => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.6);
                });
            }, notes.length * 70);
        }

        function playPerfectSound() {
            if (!audioCtx) return;
            const notes = [
                { freq: 523, time: 0 }, { freq: 659, time: 0.1 }, { freq: 784, time: 0.2 },
                { freq: 1047, time: 0.3 }, { freq: 1319, time: 0.5 }, { freq: 1568, time: 0.7 },
                { freq: 2093, time: 0.9 }
            ];
            notes.forEach(({ freq, time }) => {
                setTimeout(() => {
                    if (!audioCtx) return;
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.5);
                }, time * 1000);
            });
            setTimeout(() => {
                if (!audioCtx) return;
                [1047, 1319, 1568, 2093].forEach(freq => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 1.5);
                });
            }, 1100);
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    if (!audioCtx) return;
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(2000 + Math.random() * 2000, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.15);
                }, 1500 + i * 200);
            }
        }

        // ========== BLOCKS ==========
        function generateBalancedBlocks() {
            const blocks = [];
            PART_OPTIONS.forEach(parts => {
                blocks.push({ parts, color: COLORS[Math.floor(Math.random() * COLORS.length)], id: blocks.length });
                blocks.push({ parts, color: COLORS[Math.floor(Math.random() * COLORS.length)], id: blocks.length });
            });
            for (let i = blocks.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [blocks[i], blocks[j]] = [blocks[j], blocks[i]];
            }
            blocks.forEach((block, index) => { block.id = index; });
            return blocks;
        }

        function renderBlock(block, index) {
            const row = document.createElement('div');
            row.className = `partition-row block-${block.color}`;
            if (index === currentIndex) row.classList.add('current');
            else if (index === currentIndex + 1) row.classList.add('next');
            row.dataset.id = block.id;
            row.dataset.parts = block.parts;
            row.dataset.color = block.color;
            for (let i = 1; i <= block.parts; i++) {
                const part = document.createElement('div');
                part.className = 'block-part';
                part.textContent = i;
                row.appendChild(part);
            }
            return row;
        }

        function renderAllBlocks() {
            const stack = document.getElementById('block-stack');
            stack.innerHTML = '';
            blocks.forEach((block, index) => stack.appendChild(renderBlock(block, index)));
        }

        function updateBlockStates() {
            document.querySelectorAll('.partition-row').forEach(row => {
                const blockId = parseInt(row.dataset.id);
                row.classList.remove('current', 'next');
                if (blockId === currentIndex) row.classList.add('current');
                else if (blockId === currentIndex + 1) row.classList.add('next');
            });
        }

        // ========== EFFECTS ==========
        function screenShake() {
            const container = document.getElementById('game-container');
            container.classList.add('shake');
            setTimeout(() => container.classList.remove('shake'), 300);
        }

        function spawnFragments(element, color) {
            if (!element) return;
            const rect = element.getBoundingClientRect();
            const colorHex = COLOR_HEX[color] || '#ffd93d';
            for (let i = 0; i < 12; i++) {
                const fragment = document.createElement('div');
                fragment.className = 'fragment';
                fragment.style.background = colorHex;
                fragment.style.left = (rect.left + rect.width / 2) + 'px';
                fragment.style.top = (rect.top + rect.height / 2) + 'px';
                const angle = (i / 12) * Math.PI * 2;
                const velocity = 80 + Math.random() * 60;
                fragment.animate([
                    { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle) * velocity}px, ${Math.sin(angle) * velocity - 50 + 100}px) rotate(${Math.random() * 720 - 360}deg)`, opacity: 0 }
                ], { duration: 600, easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)' });
                document.body.appendChild(fragment);
                setTimeout(() => fragment.remove(), 600);
            }
        }

        function spawnParticles(element) {
            if (!element) return;
            const rect = element.getBoundingClientRect();
            const emojis = ['‚ú®', '‚≠ê', 'üí´'];
            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                const angle = Math.random() * Math.PI * 2;
                const distance = 40 + Math.random() * 40;
                particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance - 60}px) scale(0)`, opacity: 0 }
                ], { duration: 700, easing: 'ease-out' });
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 700);
            }
        }

        function showComboText(text, x, y, isPerfect = false) {
            const combo = document.createElement('div');
            combo.className = 'combo-text' + (isPerfect ? ' perfect' : '');
            combo.textContent = text;
            combo.style.left = x + 'px';
            combo.style.top = y + 'px';
            document.body.appendChild(combo);
            setTimeout(() => combo.remove(), 800);
        }

        function settleRemainingBlocks() {
            document.querySelectorAll('.partition-row:not(.exploding)').forEach((row, i) => {
                setTimeout(() => {
                    row.classList.add('settling');
                    setTimeout(() => row.classList.remove('settling'), 300);
                }, i * 30);
            });
        }

        function spawnConfetti(count) {
            const colors = ['#ff6b6b', '#ffd93d', '#4ecdc4', '#667eea', '#a55eea', '#ff6b9d'];
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.width = confetti.style.height = (8 + Math.random() * 10) + 'px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 2000);
                }, i * 40);
            }
        }

        function spawnFloatingStars() {
            const emojis = ['‚≠ê', '‚ú®', 'üí´', 'üåü'];
            for (let i = 0; i < 12; i++) {
                const star = document.createElement('div');
                star.className = 'floating-star';
                star.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(star);
            }
        }

        function spawnGoldParticles() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'gold-particle';
                    particle.style.left = Math.random() * 100 + 'vw';
                    particle.animate([
                        { transform: 'translateY(0)', opacity: 1 },
                        { transform: 'translateY(-100vh)', opacity: 0 }
                    ], { duration: 1500 + Math.random() * 1500, easing: 'ease-out' });
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 3000);
                }, i * 100);
            }
        }

        function spawnFireworks() {
            const colors = ['#ff6b6b', '#ffd93d', '#4ecdc4', '#a55eea', '#ff6b9d'];
            function createFirework(x, y, delay) {
                setTimeout(() => {
                    for (let i = 0; i < 20; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework';
                        particle.style.left = x + 'px';
                        particle.style.top = y + 'px';
                        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                        const angle = (i / 20) * Math.PI * 2;
                        const distance = 50 + Math.random() * 50;
                        particle.style.boxShadow = `0 0 6px ${particle.style.background}`;
                        particle.animate([
                            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                            { transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0)`, opacity: 0 }
                        ], { duration: 800, easing: 'ease-out' });
                        document.body.appendChild(particle);
                        setTimeout(() => particle.remove(), 800);
                    }
                }, delay);
            }
            createFirework(window.innerWidth * 0.2, window.innerHeight * 0.3, 500);
            createFirework(window.innerWidth * 0.8, window.innerHeight * 0.25, 800);
            createFirework(window.innerWidth * 0.5, window.innerHeight * 0.2, 1100);
            createFirework(window.innerWidth * 0.3, window.innerHeight * 0.4, 1400);
            createFirework(window.innerWidth * 0.7, window.innerHeight * 0.35, 1700);
        }

        // ========== UI ==========
        function updateProgress() {
            const pct = (currentIndex / TOTAL_BLOCKS) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-text').textContent = `${currentIndex} / ${TOTAL_BLOCKS} blocks cleared`;
        }

        function showSpeedBonus() {
            const bonus = document.getElementById('speed-bonus');
            bonus.classList.add('show');
            setTimeout(() => bonus.classList.remove('show'), 1000);
        }

        function updateStreakDisplay() {
            const streakEl = document.getElementById('streak');
            streakEl.textContent = streak + ' üî•';
            streakEl.classList.remove('hot', 'fire');
            if (streak >= 6) streakEl.classList.add('fire');
            else if (streak >= 3) streakEl.classList.add('hot');
        }

        function popStat(id) {
            const el = document.getElementById(id);
            el.classList.add('pop');
            setTimeout(() => el.classList.remove('pop'), 300);
        }

        function showMessage(type, text, subtext) {
            const popup = document.getElementById('message-popup');
            document.getElementById('msg-emoji').textContent = type === 'correct' ? 'üí•' : 'üí™';
            document.getElementById('msg-text').textContent = text;
            document.getElementById('msg-subtext').textContent = subtext;
            popup.className = 'show ' + type;
            setTimeout(() => popup.classList.remove('show'), 600);
        }

        // ========== GAME LOGIC ==========
        function checkAnswer(parts) {
            if (!gameActive || !canAnswer) return;

            const now = performance.now();
            const responseTime = (now - lastAnswerTime) / 1000;
            const currentBlock = blocks[currentIndex];
            const btn = document.querySelector(`.fraction-btn[data-parts="${parts}"]`);
            const row = document.querySelector(`.partition-row[data-id="${currentIndex}"]`);

            if (parseInt(parts) === currentBlock.parts) {
                canAnswer = false;
                let points = 10 + (streak * 2);
                const isPerfect = responseTime < PERFECT_THRESHOLD;
                const isQuick = responseTime < SPEED_BONUS_THRESHOLD;
                if (isPerfect) points += 5;
                else if (isQuick) points += 2;

                playBlastSound(streak + 1, currentIndex);
                screenShake();

                btn.classList.add('correct');
                setTimeout(() => btn.classList.remove('correct'), 300);

                if (row) {
                    const rect = row.getBoundingClientRect();
                    if (isPerfect) showComboText('‚ö° PERFECT!', rect.left + rect.width / 2 - 50, rect.top - 20, true);
                    else if (isQuick) showSpeedBonus();

                    row.classList.add('flash');
                    setTimeout(() => {
                        row.classList.remove('current', 'flash');
                        row.classList.add('exploding');
                        spawnFragments(row, currentBlock.color);
                        spawnParticles(row);
                    }, 100);

                    if (streak > 0 && (streak + 1) % 3 === 0) {
                        showComboText(`${streak + 1}x COMBO!`, rect.left + rect.width / 2 - 40, rect.top);
                    }
                }

                score += points;
                streak++;
                if (streak > bestStreak) bestStreak = streak;

                document.getElementById('score').textContent = score;
                updateStreakDisplay();
                popStat('score');

                showMessage('correct', HYPE_MESSAGES[Math.floor(Math.random() * HYPE_MESSAGES.length)], `+${points}`);

                currentIndex++;
                updateProgress();
                lastAnswerTime = now;

                setTimeout(() => {
                    if (row) row.remove();
                    settleRemainingBlocks();
                    if (currentIndex >= blocks.length) {
                        setTimeout(winGame, 200);
                    } else {
                        updateBlockStates();
                        canAnswer = true;
                    }
                }, 400);

            } else {
                playWrongSound();
                btn.classList.add('wrong');
                setTimeout(() => btn.classList.remove('wrong'), 400);
                if (row) {
                    row.classList.add('wrong');
                    setTimeout(() => row.classList.remove('wrong'), 400);
                }
                streak = 0;
                updateStreakDisplay();
                showMessage('wrong', GROWTH_MESSAGES[Math.floor(Math.random() * GROWTH_MESSAGES.length)], '');
            }
        }

        function startGame() {
            initAudio();
            score = 0;
            streak = 0;
            bestStreak = 0;
            currentIndex = 0;
            gameActive = true;
            canAnswer = true;
            gameStartTime = performance.now();
            lastAnswerTime = gameStartTime;

            blocks = generateBalancedBlocks();

            document.getElementById('score').textContent = '0';
            document.getElementById('streak').textContent = '0 üî•';
            document.getElementById('streak').classList.remove('hot', 'fire');
            updateProgress();
            renderAllBlocks();

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('show');
            document.getElementById('perfect-screen').classList.remove('show');
            
            // Clean up any leftover floating stars
            document.querySelectorAll('.floating-star').forEach(el => el.remove());
        }

        function winGame() {
            gameActive = false;
            const totalTime = ((performance.now() - gameStartTime) / 1000).toFixed(1);
            const isPerfectGame = bestStreak === TOTAL_BLOCKS;

            // Check for new best
            let isNewBest = false;
            if (score > allTimeBestScore) {
                allTimeBestScore = score;
                localStorage.setItem('partitionBlastBest', score.toString());
                isNewBest = true;
            }

            if (isPerfectGame) {
                // PERFECT SCORE CELEBRATION!
                showPerfectScreen(totalTime, isNewBest);
            } else {
                // Regular win screen
                playWinSound();
                spawnConfetti(50);

                document.getElementById('final-score').textContent = score;
                document.getElementById('best-streak').textContent = bestStreak;
                document.getElementById('final-time').textContent = totalTime + 's';
                document.getElementById('new-best').style.display = isNewBest ? 'block' : 'none';
                document.getElementById('end-screen').classList.add('show');
            }
        }

        function showPerfectScreen(totalTime, isNewBest) {
            // Screen flash
            const flash = document.createElement('div');
            flash.className = 'screen-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 500);

            // Update perfect screen content
            document.getElementById('perfect-score-display').textContent = score + ' points';
            document.getElementById('perfect-new-best').style.display = isNewBest ? 'block' : 'none';

            // Show screen
            document.getElementById('perfect-screen').classList.add('show');

            // Play epic sound
            playPerfectSound();

            // Spawn ALL the effects!
            spawnConfetti(80);
            spawnFloatingStars();
            spawnGoldParticles();
            spawnFireworks();

            // More confetti waves
            setTimeout(() => spawnConfetti(40), 1000);
            setTimeout(() => spawnConfetti(40), 2000);
        }

        function updateBestScoreDisplay() {
            const display = document.getElementById('best-score-display');
            if (allTimeBestScore > 0) {
                display.textContent = `üèÜ Best Score: ${allTimeBestScore}`;
            }
        }

        // ========== EVENTS ==========
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('play-again-btn').addEventListener('click', startGame);
        document.getElementById('perfect-play-again-btn').addEventListener('click', startGame);

        document.querySelectorAll('.fraction-btn').forEach(btn => {
            btn.addEventListener('click', () => checkAnswer(btn.dataset.parts));
        });

        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            const keyMap = { '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '8': '8' };
            if (keyMap[e.key]) checkAnswer(keyMap[e.key]);
        });

        updateBestScoreDisplay();
    </script>
</body>
</html>
